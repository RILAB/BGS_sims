---
title: "Background selection in maize and humans"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

```{r setup}
knitr::opts_knit$set(root.dir = '~/Documents/bgs_sims/')
```


#Boring Libraries and functions

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggridges)
library(viridis)
library(cowplot)
```

### Europeans

For Europeans, we follow a slightly modified model of [Torres et al. 2017](http://www.biorxiv.org/content/early/2017/09/01/181859) but the gene model is as above. Our demographic model is 

```{r munge function}
read_sim<-function(pidata,xidata,neutral=FALSE){
  #read data
  pi<-as.tibble(read.csv(pidata,header=T))
  pi<-mutate(pi,stat=rep("pi",length(pi[,1])))
  xi<-as.tibble(read.csv(xidata,header=T)) 
  xi<-mutate(xi,stat=rep("xi",length(xi[,1])))
  #munge into single tibble of means
  data<-rbind(xi,pi) %>%
    `colnames<-`(c("gen", 1:21, "sim", "stat")) %>%
    gather(window,value,2:22) %>% 
    group_by(gen,stat,window) %>%
    summarize(mean_val=mean(value)) %>%
    mutate(window=(as.numeric(window)-11)*10000*1.66e-6,mean_val=mean_val)
    data=mutate(data,mean_val=if_else(window==0.00,mean_val*1.25,mean_val))
  if(neutral==TRUE){
    data=mutate(data,mean_val=if_else(window==0.00,mean_val/1.25,mean_val))
  }

  return(data)
}


```


```{r plot_fun}
simplot<-function(somedata,mystat,label){
  ggplot(filter(somedata,gen %% 100 <1,stat==mystat), aes(x=window, y=mean_val, group = gen,color=gen)) + 
  scale_color_viridis(name='Generation') +   
  background_grid(major = "xy", minor = "none") +
  geom_line() + 
  ylab(label)  + xlab("cM") #+
#  scale_x_continuous(breaks = seq(-1.5,1.5,0.5))
}
```

```{r}
merge_sel_neutral <- function(sel_sim_data,neut_sim_data){
  merged <- merge(sel_sim_data,neut_sim_data,by=c('gen','stat','window'))
  merged$mean_val <- merged$mean_val.x/merged$mean_val.y
  merged
}

```


```{r}
setwd('~/Documents/bgs_sims/')
```

```{r}
demog_torres <- read.csv('demographies/torres.csv')
demog_torres <- mutate(demog_torres,model='torres')
demog_ten <- read.csv('demographies/tennessen.csv')
demog_ten <- mutate(demog_ten,model='tennessen')
demog <- rbind(demog_torres,demog_ten)
dem_plot <- ggplot(demog,aes(x=generation,y=N,color=model))+geom_line(size=2) + scale_y_log10()+ xlim(-0.1,1.25)

```
## Tennessen

```{r}

tennessen_neutral <-read_sim("results/tennessen_neutral_pi.csv","results/tennessen_neutral_xi.csv",neutral=TRUE)
simplot(tennessen_neutral,"pi",expression(bar(pi)))
tennessen_bgs <-read_sim("results/tennessen_bgs_pi.csv","results/tennessen_bgs_xi.csv",neutral=FALSE)
simplot(tennessen_bgs,"pi",expression(bar(pi)))

tennessen <- merge_sel_neutral(tennessen_bgs,tennessen_neutral)
tennessen <- mutate(tennessen,gen=as.numeric(gen)/7310)
simplot(tennessen,"pi",expression(bar(pi)/bar(pi)[neut]))

simplot(tennessen,"xi",expression(bar(xi)/bar(xi)[neut]))

comb <- tennessen %>%
  filter(window==0)
start_val <- comb %>%
  filter(gen<=min(gen))
div_ten <- ggplot(comb,aes(gen,mean_val,color=stat)) +geom_line(size=1.5) +
  geom_hline(yintercept = start_val$mean_val) +
  labs(x='Generation',y=expression(x/x[neut]),color='Statistics') + xlim(-0.1,1.25)
```

## Torres
```{r}
torres_neutral <-read_sim("results/torres_neutral_pi.csv","results/torres_neutral_xi.csv",neutral=TRUE)
simplot(torres_neutral,"xi",expression(bar(pi)))
torres_bgs <-read_sim("results/torres_bgs_pi.csv","results/torres_bgs_xi.csv",neutral=FALSE)
simplot(torres_bgs,"pi",expression(bar(pi)))

torres <- merge_sel_neutral(torres_bgs,torres_neutral)
torres <- mutate(torres,gen=as.numeric(gen)/18448)

simplot(torres,"pi",expression(bar(pi)/bar(pi)[neut]))
simplot(torres,"xi",expression(bar(xi)/bar(xi)[neut]))


comb <- torres %>%
  filter(window==0.0332)
start_val <- comb %>%
  filter(gen<=-0.00542064)
div_torres <- ggplot(comb,aes(gen,mean_val,color=stat)) +geom_line(size=1.5) +
  geom_hline(yintercept = start_val$mean_val) +
  labs(x='Generation',y=expression(x/x[neut]),color='Statistics')+ xlim(-0.1,1.25)
```

```{r}
plot_grid(dem_plot,div_ten,div_torres,ncol = 1,align = 'hv')
ggsave('results/human_pi_xi.pdf')
```
